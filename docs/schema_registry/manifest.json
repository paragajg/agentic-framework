{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://agent-framework.io/schemas/manifest.json",
  "title": "Workflow Manifest",
  "description": "A YAML-serializable schema defining an agentic workflow with subagent steps, memory management, tool access, and policies",
  "type": "object",
  "required": [
    "manifest_id",
    "name",
    "version",
    "steps"
  ],
  "properties": {
    "manifest_id": {
      "type": "string",
      "description": "Unique identifier for this manifest",
      "pattern": "^[a-z0-9-]+$",
      "examples": ["customer-support-workflow"]
    },
    "name": {
      "type": "string",
      "description": "Human-readable name for the workflow",
      "minLength": 3,
      "maxLength": 100,
      "examples": ["Customer Support Ticket Resolution"]
    },
    "description": {
      "type": "string",
      "description": "Detailed description of what this workflow accomplishes",
      "maxLength": 1000,
      "examples": ["Multi-step workflow for handling customer support tickets: research context, verify claims, draft response, and synthesize final output"]
    },
    "version": {
      "type": "string",
      "description": "Semantic version of the manifest",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$",
      "examples": ["1.0.0", "2.1.3"]
    },
    "steps": {
      "type": "array",
      "description": "Ordered list of workflow steps to execute",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["id", "role"],
        "properties": {
          "id": {
            "type": "string",
            "description": "Unique identifier for this step within the workflow",
            "pattern": "^[a-z0-9_-]+$",
            "examples": ["research-context", "verify-claims", "draft-response"]
          },
          "role": {
            "type": "string",
            "enum": ["research", "verify", "code", "synthesis", "analysis", "planning", "execution", "review"],
            "description": "The role or capability domain of this step",
            "examples": ["research"]
          },
          "agent": {
            "type": "string",
            "description": "Specific subagent to use (if omitted, orchestrator selects based on role)",
            "pattern": "^[a-z0-9_-]+$",
            "examples": ["research-agent-001", "verify-agent-002"]
          },
          "capabilities": {
            "type": "array",
            "description": "List of capabilities or tools this step is allowed to use",
            "items": {
              "type": "string",
              "pattern": "^[a-z0-9_-]+$"
            },
            "uniqueItems": true,
            "default": [],
            "examples": [["web_search", "document_read", "kb_query"]]
          },
          "inputs": {
            "type": "array",
            "description": "Input artifacts required for this step (references to previous step outputs or initial inputs)",
            "items": {
              "type": "object",
              "required": ["name"],
              "properties": {
                "name": {
                  "type": "string",
                  "description": "Name of the input parameter"
                },
                "source": {
                  "type": "string",
                  "description": "Source of the input (step ID or 'workflow_input')",
                  "examples": ["workflow_input", "research-context"]
                },
                "artifact_type": {
                  "type": "string",
                  "description": "Expected artifact type",
                  "examples": ["research_snippet", "claim_verification", "string"]
                },
                "required": {
                  "type": "boolean",
                  "description": "Whether this input is required",
                  "default": true
                }
              },
              "additionalProperties": false
            },
            "default": []
          },
          "outputs": {
            "type": "array",
            "description": "Output artifacts produced by this step",
            "items": {
              "type": "object",
              "required": ["name", "artifact_type"],
              "properties": {
                "name": {
                  "type": "string",
                  "description": "Name of the output artifact"
                },
                "artifact_type": {
                  "type": "string",
                  "description": "Type of artifact produced",
                  "examples": ["research_snippet", "claim_verification", "code_patch"]
                },
                "schema_ref": {
                  "type": "string",
                  "description": "Reference to JSON Schema for validation",
                  "examples": ["schema_registry/research_snippet.json"]
                }
              },
              "additionalProperties": false
            },
            "default": []
          },
          "timeout": {
            "type": "integer",
            "description": "Maximum execution time for this step in seconds",
            "minimum": 1,
            "maximum": 3600,
            "default": 300,
            "examples": [30, 60, 120]
          },
          "retries": {
            "type": "integer",
            "description": "Number of retry attempts on failure",
            "minimum": 0,
            "maximum": 5,
            "default": 0,
            "examples": [2]
          },
          "conditions": {
            "type": "object",
            "description": "Conditions for executing this step",
            "properties": {
              "skip_if": {
                "type": "string",
                "description": "Expression that if true, skips this step",
                "examples": ["previous_step.confidence > 0.95"]
              },
              "run_if": {
                "type": "string",
                "description": "Expression that must be true to run this step",
                "examples": ["workflow_input.ticket_priority == 'high'"]
              }
            },
            "additionalProperties": false
          },
          "system_prompt": {
            "type": "string",
            "description": "System prompt to use for this step (overrides default for role)",
            "maxLength": 5000,
            "examples": ["You are a research assistant specializing in technical documentation..."]
          }
        },
        "additionalProperties": false
      }
    },
    "memory": {
      "type": "object",
      "description": "Memory management configuration for this workflow",
      "properties": {
        "persist_on": {
          "type": "array",
          "description": "Events that trigger memory persistence",
          "items": {
            "type": "string",
            "enum": [
              "step_complete",
              "workflow_complete",
              "error",
              "manual_commit",
              "artifact_created",
              "high_confidence_output"
            ]
          },
          "uniqueItems": true,
          "default": ["workflow_complete"],
          "examples": [["step_complete", "workflow_complete"]]
        },
        "compaction": {
          "type": "object",
          "description": "Memory compaction strategy to manage context size",
          "properties": {
            "strategy": {
              "type": "string",
              "enum": ["none", "summarize", "truncate", "sliding_window", "hierarchical"],
              "description": "Compaction strategy to use",
              "default": "none",
              "examples": ["summarize"]
            },
            "max_tokens": {
              "type": "integer",
              "description": "Maximum tokens to retain in active context",
              "minimum": 1000,
              "maximum": 200000,
              "default": 8000,
              "examples": [8000, 16000, 32000]
            },
            "trigger_threshold": {
              "type": "number",
              "description": "Percentage of max_tokens that triggers compaction (0.0 to 1.0)",
              "minimum": 0.5,
              "maximum": 1.0,
              "default": 0.8,
              "examples": [0.8, 0.9]
            },
            "preserve_artifacts": {
              "type": "boolean",
              "description": "Whether to preserve full artifact structures during compaction",
              "default": true
            }
          },
          "additionalProperties": false
        },
        "retention": {
          "type": "object",
          "description": "Data retention policies",
          "properties": {
            "hot_storage_days": {
              "type": "integer",
              "description": "Days to keep in hot storage (Redis)",
              "minimum": 1,
              "default": 7
            },
            "warm_storage_days": {
              "type": "integer",
              "description": "Days to keep in warm storage (Postgres)",
              "minimum": 1,
              "default": 90
            },
            "cold_storage_days": {
              "type": "integer",
              "description": "Days to keep in cold storage (S3) before deletion",
              "minimum": 30,
              "default": 365
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "tools": {
      "type": "object",
      "description": "Tool and MCP server configuration for this workflow",
      "properties": {
        "catalog_ids": {
          "type": "array",
          "description": "List of tool catalog IDs or MCP servers to make available",
          "items": {
            "oneOf": [
              {
                "type": "string",
                "description": "Simple catalog ID reference",
                "examples": ["filesystem", "github", "postgres"]
              },
              {
                "type": "object",
                "description": "Catalog ID with configuration",
                "required": ["id"],
                "properties": {
                  "id": {
                    "type": "string",
                    "description": "Catalog ID"
                  },
                  "scopes": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    },
                    "description": "Specific scopes or permissions needed"
                  },
                  "rate_limit": {
                    "type": "integer",
                    "description": "Rate limit in calls per minute",
                    "minimum": 1
                  },
                  "config": {
                    "type": "object",
                    "description": "Additional configuration parameters",
                    "additionalProperties": true
                  }
                },
                "additionalProperties": false
              }
            ]
          },
          "default": [],
          "examples": [
            ["filesystem", "github"],
            [
              "filesystem",
              {
                "id": "github",
                "scopes": ["repo:read", "issues:write"],
                "rate_limit": 60
              }
            ]
          ]
        },
        "access_mode": {
          "type": "string",
          "enum": ["orchestrated", "scoped_direct"],
          "description": "How subagents access tools: orchestrated (via lead agent) or scoped_direct (ephemeral tokens)",
          "default": "orchestrated",
          "examples": ["orchestrated"]
        }
      },
      "additionalProperties": false
    },
    "policies": {
      "type": "object",
      "description": "Workflow-level policies and governance",
      "properties": {
        "requires_human_approval": {
          "type": "boolean",
          "description": "Whether workflow execution requires human approval before starting",
          "default": false,
          "examples": [false]
        },
        "approval_steps": {
          "type": "array",
          "description": "Specific steps that require human approval before execution",
          "items": {
            "type": "string",
            "description": "Step ID that requires approval"
          },
          "default": [],
          "examples": [["draft-response", "merge-code"]]
        },
        "pii_handling": {
          "type": "string",
          "enum": ["allow", "redact", "reject", "flag"],
          "description": "How to handle PII detected in inputs or outputs",
          "default": "flag",
          "examples": ["redact"]
        },
        "max_cost_usd": {
          "type": "number",
          "description": "Maximum estimated cost in USD for workflow execution",
          "minimum": 0.0,
          "examples": [5.0, 10.0]
        },
        "security_level": {
          "type": "string",
          "enum": ["public", "internal", "confidential", "restricted"],
          "description": "Security classification for workflow data",
          "default": "internal",
          "examples": ["internal"]
        }
      },
      "additionalProperties": false
    },
    "metadata": {
      "type": "object",
      "description": "Additional metadata for the manifest",
      "properties": {
        "author": {
          "type": "string",
          "description": "Author or team that created this manifest",
          "examples": ["engineering-team"]
        },
        "created_at": {
          "type": "string",
          "format": "date-time",
          "description": "When manifest was created"
        },
        "updated_at": {
          "type": "string",
          "format": "date-time",
          "description": "When manifest was last updated"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Tags for categorization",
          "examples": [["customer-support", "automation", "production"]]
        },
        "documentation_url": {
          "type": "string",
          "format": "uri",
          "description": "URL to detailed documentation"
        }
      },
      "additionalProperties": true
    }
  },
  "additionalProperties": false,
  "examples": [
    {
      "manifest_id": "customer-support-workflow",
      "name": "Customer Support Ticket Resolution",
      "description": "Multi-step workflow for handling customer support tickets: research context, verify claims, draft response, and synthesize final output",
      "version": "1.0.0",
      "steps": [
        {
          "id": "research-context",
          "role": "research",
          "agent": "research-agent-001",
          "capabilities": ["web_search", "kb_query", "document_read"],
          "inputs": [
            {
              "name": "ticket",
              "source": "workflow_input",
              "artifact_type": "string",
              "required": true
            }
          ],
          "outputs": [
            {
              "name": "context",
              "artifact_type": "research_snippet",
              "schema_ref": "schema_registry/research_snippet.json"
            }
          ],
          "timeout": 60
        },
        {
          "id": "verify-claims",
          "role": "verify",
          "agent": "verify-agent-002",
          "capabilities": ["cross_reference", "fact_check"],
          "inputs": [
            {
              "name": "context",
              "source": "research-context",
              "artifact_type": "research_snippet",
              "required": true
            }
          ],
          "outputs": [
            {
              "name": "verification",
              "artifact_type": "claim_verification",
              "schema_ref": "schema_registry/claim_verification.json"
            }
          ],
          "timeout": 45
        },
        {
          "id": "draft-response",
          "role": "synthesis",
          "capabilities": ["text_generation", "tone_check"],
          "inputs": [
            {
              "name": "context",
              "source": "research-context",
              "artifact_type": "research_snippet"
            },
            {
              "name": "verification",
              "source": "verify-claims",
              "artifact_type": "claim_verification"
            }
          ],
          "outputs": [
            {
              "name": "response",
              "artifact_type": "string"
            }
          ],
          "timeout": 30
        }
      ],
      "memory": {
        "persist_on": ["step_complete", "workflow_complete"],
        "compaction": {
          "strategy": "summarize",
          "max_tokens": 8000,
          "trigger_threshold": 0.8,
          "preserve_artifacts": true
        },
        "retention": {
          "hot_storage_days": 7,
          "warm_storage_days": 90,
          "cold_storage_days": 365
        }
      },
      "tools": {
        "catalog_ids": [
          "filesystem",
          {
            "id": "github",
            "scopes": ["repo:read", "issues:write"],
            "rate_limit": 60
          },
          "postgres"
        ],
        "access_mode": "orchestrated"
      },
      "policies": {
        "requires_human_approval": false,
        "approval_steps": ["draft-response"],
        "pii_handling": "redact",
        "max_cost_usd": 2.0,
        "security_level": "internal"
      },
      "metadata": {
        "author": "support-engineering-team",
        "created_at": "2025-12-28T14:00:00Z",
        "updated_at": "2025-12-28T14:00:00Z",
        "tags": ["customer-support", "automation", "production"],
        "documentation_url": "https://docs.company.com/workflows/customer-support"
      }
    }
  ]
}
